<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Call</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --danger: #f43f5e;
            --success: #10b981;
            --bg-dark: #0b0f1a;
            --panel-bg: rgba(23, 32, 53, 0.8);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            background: radial-gradient(circle at top right, #1e1b4b, #0b0f1a);
        }

        .sidebar {
            width: 320px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .sidebar-header { padding: 30px 24px; border-bottom: 1px solid var(--glass-border); }
        .contact-list { flex-grow: 1; overflow-y: auto; padding: 15px; }

        .contact-card {
            padding: 14px 18px;
            border-radius: 16px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid transparent;
        }

        .contact-card:hover { background: rgba(255, 255, 255, 0.05); transform: translateY(-1px); }
        .contact-card.active { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); }

        .avatar-placeholder {
            width: 42px; height: 42px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .main-view {
            flex: 1;
            position: relative;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle, #1a1f35 0%, #000 100%);
            overflow: hidden;
        }

        #remoteVideo {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Змінено з cover: тепер бачимо все зображення */
    background-color: #000;
}

    #localVideo {
            position: absolute;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* Тінь для об'єму */
            transition: box-shadow 0.1s ease;
            top: 25px;
            right: 25px;
            width: 25vw; /* Відносний розмір */
            max-width: 240px;
            min-width: 120px;
            border-radius: 16px;
            z-index: 10;
            transform: scaleX(-1);
            background: #2d2d2d;
            object-fit: contain; /* Тепер твоє відео теж не обрізається */
            aspect-ratio: auto;
        }

        .speaking-glow {
        box-shadow: 0 0 20px 8px rgba(99, 102, 241, 0.8) !important;
    }

/* Налаштування саме для ТЕЛЕФОНІВ */
        @media (max-width: 992px) {
            .sidebar { position: absolute; left: -320px; height: 100%; }
            .sidebar.active { left: 0; }
            
            #localVideo { 
                width: 30vw;
                max-width: 140px;
                aspect-ratio: 9 / 16; /* Вертикальний для смартфонів */
                top: auto !important;
                bottom: 120px;
                right: 15px;
            }
        }

        #localVideo.speaking {
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(99, 102, 241, 0.6);
        }

        .status-pill {
            position: absolute; top: 25px; left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            padding: 8px 24px;
            border-radius: 30px;
            font-size: 13px; font-weight: 500;
            z-index: 20;
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 10px;
            color: #cbd5e1;
        }

        .status-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }

        .controls-wrapper {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 12px; padding: 16px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(24px);
            border-radius: 24px;
            z-index: 30;
            border: 1px solid var(--glass-border);
        }

        .action-btn {
            width: 52px; height: 52px;
            border-radius: 16px; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; transition: all 0.3s ease;
            color: white; cursor: pointer;
            background: rgba(255, 255, 255, 0.08);
        }

        .action-btn:hover:not(:disabled) { transform: translateY(-5px); background: rgba(255, 255, 255, 0.15); }
        .action-btn.btn-call { background: var(--success); }
        .action-btn.btn-end { background: var(--danger); }
        .action-btn.off { background: var(--danger); }

        #incomingCallModal {
            display: none; position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #1e293b; padding: 40px; border-radius: 32px;
            z-index: 2000; box-shadow: 0 0 100px rgba(0,0,0,0.8);
            width: 90%; max-width: 380px; text-align: center;
        }

        #incomingCallModal.show { display: block; animation: modalIn 0.4s ease-out; }

        @keyframes modalIn {
            from { opacity: 0; transform: translate(-50%, -45%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }

        @media (max-width: 992px) {
            .sidebar { position: absolute; left: -320px; height: 100%; }
            .sidebar.active { left: 0; }
            #localVideo { 
                width: 100px !important; height: 177px !important; 
                aspect-ratio: 9/16 !important; bottom: 120px; top: auto !important; right: 15px !important;
                border-radius: 12px;
            }
            #remoteVideo { aspect-ratio: 9/16; }
            .controls-wrapper { width: 95%; justify-content: space-around; bottom: 20px; }
        }
    </style>
</head>
<body>

<audio id="sndIncoming" src="https://www.orangefreesounds.com/wp-content/uploads/2019/03/Calling-ringtone.mp3" loop></audio>
<audio id="sndOutgoing" src="https://ringtoneop.com/wp-content/uploads/2024/06/cool-and-calm.mp3" loop></audio>
<audio id="sndEnd" src=""></audio>

<div id="incomingCallModal">
    <div class="mb-4">
        <div class="avatar-placeholder mx-auto" style="width: 80px; height: 80px; font-size: 32px;">
            <i class="fas fa-video"></i>
        </div>
    </div>
    <h4 id="callerName" class="mb-2">Вхідний виклик</h4>
    <p class="text-secondary mb-5">Запрошення до відеозв'язку...</p>
    <div class="d-flex gap-3">
        <button onclick="acceptCall()" class="btn btn-success flex-grow-1 rounded-4 py-3 fw-semibold">Прийняти</button>
        <button onclick="rejectCall()" class="btn btn-outline-light flex-grow-1 rounded-4 py-3 fw-semibold">Відхилити</button>
    </div>
</div>

<div class="app-container">
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h4 class="mb-4 fw-bold">Дзвінки</h4>
        </div>
        <div class="contact-list">
            <p class="small text-uppercase text-secondary fw-bold mb-3 px-2">Контакти</p>
            <div th:each="c : ${contacts}" class="contact-card" th:onclick="selectUser(this, [[${c.contactUser.name}]])">
                <div class="avatar-placeholder">
                    <span th:text="${#strings.substring(c.name,0,1)}">U</span>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-semibold text-white" th:text="${c.name}">Name</div>
                    <div class="small text-secondary">Натисніть для вибору</div>
                </div>
            </div>
        </div>
        <div class="p-4 border-top border-white border-opacity-10">
            <a th:href="@{/}" class="btn btn-dark w-100 rounded-4 py-2 text-danger fw-medium">
                <i class="fas fa-sign-out-alt me-2"></i>Вийти
            </a>
        </div>
    </aside>

    <main class="main-view">
        <button onclick="toggleSidebar()" class="btn d-lg-none" style="position: absolute; left: 20px; top: 25px; z-index: 100; color: white; background: rgba(0,0,0,0.5); border-radius: 12px;">
            <i class="fas fa-bars"></i>
        </button>

        <div class="status-pill">
            <div class="status-dot"></div>
            <span id="callStatus">Система готова</span>
        </div>

        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline style="opacity: 0;"></video>

        <div class="controls-wrapper">
            <button id="toggleMic" class="action-btn" title="Мікрофон"><i class="fas fa-microphone"></i></button>
            <button id="toggleVid" class="action-btn" title="Камера"><i class="fas fa-video"></i></button>
            <button id="toggleRemoteAudio" class="action-btn" title="Звук співрозмовника"><i class="fas fa-volume-up"></i></button>
            <button id="switchCam" class="action-btn" title="Змінити камеру"><i class="fas fa-sync"></i></button>
            <div style="width: 1px; background: var(--glass-border); margin: 0 5px;"></div>
            <button id="callBtn" class="action-btn btn-call" title="Зателефонувати"><i class="fas fa-phone"></i></button>
            <button id="endBtn" class="action-btn btn-end" title="Завершити"><i class="fas fa-phone-slash"></i></button>
        </div>
    </main>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
let localStream = null;
let peerConnection = null;
let stompClient = null;
let selectedUser = null; 
let currentOffer = null;
let iceCandidatesQueue = [];
let pendingAutoAccept = false; 
let mediaReady = false; 
let isCalling = false;
let useFrontCamera = true;
let hasMultipleCameras = false;
let audioContext, analyser, dataArray;

const servers = { 
    iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" },
        { urls: "stun:stun2.l.google.com:19302" },
        { urls: "stun:stun3.l.google.com:19302" },
        { urls: "stun:stun4.l.google.com:19302" }
        // Порада: Для продакшну додайте сюди TURN сервер (напр. Coturn або Twilio)
    ],
    // Допомагає зібрати кандидатів заздалегідь
    iceCandidatePoolSize: 10 
};
const localUser = /*[[${name}]]*/ 'user';

const sounds = {
    incoming: document.getElementById('sndIncoming'),
    outgoing: document.getElementById('sndOutgoing'),
    end: document.getElementById('sndEnd'),
    
    playIncoming: function() { 
        this.stopAll(); 
        if (this.incoming) {
            this.incoming.play().catch(e => console.error("Incoming play error:", e));
        }
    },
    
    playOutgoing: function() { 
        this.stopAll(); 
        if (this.outgoing) {
            this.outgoing.play().catch(e => console.error("Outgoing play error:", e));
        }
    },
    
    playEnd: function() { 
        this.stopAll(); 
        if (this.end && this.end.src) {
            this.end.play().catch(e => console.error("End play error:", e));
        }
    },
    
    stopAll: function() {
        [this.incoming, this.outgoing].forEach(s => { 
            if (s) {
                s.pause(); 
                s.currentTime = 0; 
            }
        });
    }
};

function unlockAudio() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    // Короткий тон майже непомітний
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.type = 'sine'; // синусоїда
    oscillator.frequency.setValueAtTime(440, ctx.currentTime); // стандартний A4
    gainNode.gain.setValueAtTime(0.02, ctx.currentTime); // дуже низька гучність

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    oscillator.start();
    oscillator.stop(ctx.currentTime + 0.05); // 50 мс

    console.log("Audio розблоковано");

    window.removeEventListener('click', unlockAudio);
    window.removeEventListener('touchstart', unlockAudio);
}

window.addEventListener('click', unlockAudio, { once: true });
window.addEventListener('touchstart', unlockAudio, { once: true });

window.onload = async () => {
    await checkCameras();
    const urlParams = new URLSearchParams(window.location.search);
    const callerFromServer = urlParams.get('caller');
    if (callerFromServer) {
        selectedUser = callerFromServer;
        pendingAutoAccept = true; 
        document.getElementById("callStatus").innerText = "Готуємо камеру...";
    }
};

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

async function checkCameras() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        hasMultipleCameras = videoDevices.length > 1;
        const btn = document.getElementById('switchCam');
        if (btn) {
            btn.disabled = !hasMultipleCameras;
            btn.style.display = hasMultipleCameras ? 'flex' : 'none';
        }
        console.log("Доступно камер:", videoDevices.length);
    } catch (e) {
        console.error("Помилка при перевірці камер:", e);
    }
}

function startVoiceDetection(stream) {
    if (audioContext) audioContext.close();
    
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
    
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    function checkVolume() {
        if (!mediaReady || !localStream || !localStream.getAudioTracks()[0]?.enabled) {
            document.getElementById("localVideo").classList.remove("speaking-glow");
            requestAnimationFrame(checkVolume);
            return;
        }

        analyser.getByteFrequencyData(dataArray);
        let values = 0;
        for (let i = 0; i < bufferLength; i++) values += dataArray[i];
        let average = values / bufferLength;

        const localVid = document.getElementById("localVideo");
        if (localVid) {
            if (average > 15) { 
                localVid.classList.add("speaking-glow");
            } else {
                localVid.classList.remove("speaking-glow");
            }
        }
        requestAnimationFrame(checkVolume);
    }
    checkVolume();
}

async function initMedia() {
    try {
        // 1. Зупиняємо старі треки, щоб звільнити камеру (важливо для Android)
        if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
        }

        const constraints = {
            audio: true,
            video: {
                // Використовуємо ідеальні значення, щоб уникнути помилок на старих телефонах
                facingMode: useFrontCamera ? "user" : "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Оновлюємо глобальну змінну, щоб PeerConnection знав, що ми використовуємо новий потік
        localStream = stream; 
        
        const localVid = document.getElementById("localVideo");
        localVid.srcObject = localStream;
        
        // Дзеркальне відображення лише для селфі-камери
        localVid.style.transform = useFrontCamera ? "scaleX(-1)" : "scaleX(1)";
        
        mediaReady = true;
        startVoiceDetection(localStream);
        
        // Після першого успішного входу — оновлюємо список камер (тепер вони видимі)
        await checkCameras();
        
        return true;
    } catch (e) { 
        console.error("Помилка ініціалізації медіа:", e);
        return false;
    }
}

document.getElementById("switchCam").onclick = async () => {
    if (!hasMultipleCameras) return;
    
    // Зберігаємо поточний стан мікрофона/відео, щоб не включити їх випадково при перемиканні
    const micWasEnabled = localStream?.getAudioTracks()[0]?.enabled ?? true;
    const vidWasEnabled = localStream?.getVideoTracks()[0]?.enabled ?? true;

    useFrontCamera = !useFrontCamera;
    const success = await initMedia(); 

    if (success) {
        // Повертаємо стан кнопок, який був до перемикання
        localStream.getAudioTracks()[0].enabled = micWasEnabled;
        localStream.getVideoTracks()[0].enabled = vidWasEnabled;

        if (peerConnection) {
            const videoTrack = localStream.getVideoTracks()[0];
            const audioTrack = localStream.getAudioTracks()[0];

            // Оновлюємо відео-трек для співрозмовника
            const vSender = peerConnection.getSenders().find(s => s.track?.kind === 'video');
            if (vSender) await vSender.replaceTrack(videoTrack);

            // Оновлюємо аудіо-трек (щоб мікрофон не зникав)
            const aSender = peerConnection.getSenders().find(s => s.track?.kind === 'audio');
            if (aSender) await aSender.replaceTrack(audioTrack);
        }
        
        // Оновлюємо візуальний стан кнопок
        updateControlButtons();
    }
};

function updateControlButtons() {
    if (!localStream) return;

    const audioTrack = localStream.getAudioTracks()[0];
    const videoTrack = localStream.getVideoTracks()[0];

    // Оновлюємо мікрофон
    const micBtn = document.getElementById("toggleMic");
    if (audioTrack) {
        const isOff = !audioTrack.enabled;
        micBtn.classList.toggle("off", isOff);
        micBtn.innerHTML = isOff ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
    }

    // Оновлюємо відео
    const vidBtn = document.getElementById("toggleVid");
    if (videoTrack) {
        const isOff = !videoTrack.enabled;
        vidBtn.classList.toggle("off", isOff);
        vidBtn.innerHTML = isOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
    }
}

function createPeer(remoteName) {
    if (peerConnection) peerConnection.close();
    peerConnection = new RTCPeerConnection(servers);

    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });

    peerConnection.ontrack = e => {
        const remoteVid = document.getElementById("remoteVideo");
        if (remoteVid.srcObject !== e.streams[0]) {
            remoteVid.srcObject = e.streams[0];
            remoteVid.onloadedmetadata = () => {
                remoteVid.play().catch(()=>{});
                remoteVid.style.opacity = "1";
            };
            document.getElementById("callStatus").innerText = "У мережі: " + remoteName;
            sounds.stopAll();
        }
    };

    peerConnection.onicecandidate = e => {
        if (e.candidate && stompClient?.connected) {
            stompClient.send("/app/candidate", {}, JSON.stringify({
                toUser: remoteName, fromUser: localUser, candidate: e.candidate
            }));
        }
    };

    peerConnection.oniceconnectionstatechange = () => {
    const state = peerConnection.iceConnectionState;
    console.log("ICE State:", state);
    
    if (state === 'failed') {
        // Спроба автоматичного рестарту ICE
        peerConnection.restartIce();
    }
    
    if (state === 'disconnected') {
        document.getElementById("callStatus").innerText = "Втрата зв'язку...";
    }
};
}

function connectWS() {
    const socket = new SockJS('/websocket');
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
        // 1. Вхідний сигнал
        stompClient.subscribe("/user/" + localUser + "/topic/call", msg => {
            const data = JSON.parse(msg.body);
            if (!pendingAutoAccept) {
                selectedUser = data.fromUser;
                document.getElementById("callerName").innerText = data.fromUser;
                document.getElementById("incomingCallModal").classList.add("show");
                sounds.playIncoming();
            }
        });

        // 2. Offer
        stompClient.subscribe("/user/" + localUser + "/topic/offer", async msg => { 
            currentOffer = JSON.parse(msg.body); 
            if (isCalling && currentOffer.fromUser === selectedUser) {
                await processReceivedOffer(); 
            } else {
                selectedUser = currentOffer.fromUser;
                document.getElementById("incomingCallModal").classList.add("show");
                sounds.playIncoming();
            }
        });

        // 3. Answer
        stompClient.subscribe("/user/" + localUser + "/topic/answer", async msg => {
            const data = JSON.parse(msg.body);
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                await processIceCandidates();
            }
        });

        // 4. Candidate
        stompClient.subscribe("/user/" + localUser + "/topic/candidate", async msg => {
            const data = JSON.parse(msg.body);
            if (peerConnection?.remoteDescription) { 
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)); 
            } else { iceCandidatesQueue.push(data.candidate); }
        });

        // 5. Завершення (ОБОВ'ЯЗКОВО ТУТ)
        stompClient.subscribe("/user/" + localUser + "/topic/endCall", () => {
            sounds.playEnd();
            resetCall("Співрозмовник завершив дзвінок");
        });

        if (pendingAutoAccept && selectedUser) acceptCall();
    });
}

async function acceptCall() {
    if (!mediaReady) { setTimeout(acceptCall, 500); return; }
    sounds.stopAll();
    document.getElementById("incomingCallModal").classList.remove("show");
    pendingAutoAccept = false;
    if (!selectedUser && currentOffer) selectedUser = currentOffer.fromUser;
    if (!selectedUser) return;

    createPeer(selectedUser);
    try {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        stompClient.send("/app/offer", {}, JSON.stringify({
            toUser: selectedUser, fromUser: localUser, offer: offer
        }));
        document.getElementById("callStatus").innerText = "Підключення...";
    } catch (err) { console.error("Offer Error:", err); }
}

async function processReceivedOffer() {
    if (!mediaReady) { setTimeout(processReceivedOffer, 500); return; }
    if (!currentOffer) return;
    createPeer(currentOffer.fromUser);
    try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(currentOffer.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        stompClient.send("/app/answer", {}, JSON.stringify({
            toUser: currentOffer.fromUser, fromUser: localUser, answer: answer
        }));
        await processIceCandidates();
    } catch (err) { console.error("Answer Error:", err); }
}

async function processIceCandidates() {
    if (!peerConnection || !peerConnection.remoteDescription) {
        console.log("Чекаємо на RemoteDescription перед додаванням кандидатів...");
        return; 
    }
    
    while (iceCandidatesQueue.length > 0) {
        const candidate = iceCandidatesQueue.shift();
        try {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            console.log("ICE кандидат успішно доданий");
        } catch (e) {
            console.warn("Помилка ICE кандидата:", e);
        }
    }
}

function selectUser(el, name) {
    selectedUser = name;
    document.querySelectorAll('.contact-card').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    document.getElementById("callStatus").innerText = "Обрано: " + name;
    if (window.innerWidth < 992) toggleSidebar();
}

document.getElementById("callBtn").addEventListener("click", unlockAudio, { once: true });
document.getElementById("callBtn").onclick = async () => {
    if(!selectedUser) return alert("Оберіть контакт!");
    if(!mediaReady) await initMedia();
    isCalling = true; 
    sounds.playOutgoing();
    stompClient.send("/app/call", {}, JSON.stringify({toUser: selectedUser, fromUser: localUser}));
    document.getElementById("callStatus").innerText = "Виклик " + selectedUser + "...";
};

function rejectCall() {
    sounds.playEnd();
    document.getElementById("incomingCallModal").classList.remove("show");
    if(selectedUser) stompClient.send("/app/endCall", {}, JSON.stringify({toUser: selectedUser, fromUser: localUser}));
    resetCall("Відхилено");
}

document.getElementById("endBtn").onclick = () => {
    if(selectedUser) {
        stompClient.send("/app/endCall", {}, JSON.stringify({toUser: selectedUser, fromUser: localUser}));
    }
    sounds.playEnd();
    resetCall("Ви завершили дзвінок");
};

function resetCall(msg) {
    sounds.stopAll();
    if (peerConnection) { peerConnection.close(); peerConnection = null; }
    document.getElementById("remoteVideo").srcObject = null;
    document.getElementById("remoteVideo").style.opacity = "0";
    document.getElementById("callStatus").innerText = msg;
    currentOffer = null;
    iceCandidatesQueue = [];
    isCalling = false;
    pendingAutoAccept = false;
}

document.getElementById("toggleMic").onclick = function() {
    if (localStream?.getAudioTracks().length > 0) {
        localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
        updateControlButtons();
    }
};

document.getElementById("toggleVid").onclick = function() {
    if (localStream?.getVideoTracks().length > 0) {
        localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
        updateControlButtons();
    }
};

document.getElementById("toggleRemoteAudio").onclick = function() {
    const remoteVid = document.getElementById("remoteVideo");
    // Перемикаємо стан mute
    remoteVid.muted = !remoteVid.muted;
    
    const isMuted = remoteVid.muted;
    this.classList.toggle("off", isMuted);
    this.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
};

initMedia().finally(() => connectWS());
/*]]>*/
</script>
</body>
</html>